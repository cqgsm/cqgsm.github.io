<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>白小菜</title>
  <subtitle>心存感激，所遇即温柔~</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://cqblog.info/"/>
  <updated>2016-07-01T02:12:36.288Z</updated>
  <id>http://cqblog.info/</id>
  
  <author>
    <name>白小菜</name>
    <email>260422909@qq.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>git服务器代码自动部署</title>
    <link href="http://cqblog.info/2016/07/01/git%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/"/>
    <id>http://cqblog.info/2016/07/01/git服务器代码自动部署/</id>
    <published>2016-07-01T01:05:24.000Z</published>
    <updated>2016-07-01T02:12:36.288Z</updated>
    
    <content type="html">&lt;p&gt;每次本地代码都要手动上传到服务器在部署，对于懒人的我来说简直不能忍，于是折腾了下git自动化部署，期间踩了不少坑，记录一下防止下次遇到。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器版本： ubantu 16.04&lt;/li&gt;
&lt;li&gt;ipaddress：请填上自己服务器地址&lt;/li&gt;
&lt;li&gt;每次操作都要输入密码，需要配置密钥认证，后期再来填坑&lt;/li&gt;
&lt;li&gt;由于是个人项目，所以没有加入权限控制，后期填坑&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;1.服务器端准备工作&lt;br&gt;=&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;这些工作都在 &lt;strong&gt;&lt;em&gt;root&lt;/em&gt;&lt;/strong&gt; 或有管理权限的帐号下进行，下面以root为用户，切换到其他用户的时候会提示&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;确保安装了git&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;apt-get install git&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;为了安全起见，新建一个专门用于代码部署的无特权用户&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;useradd -m git &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;passwd deployuser  &lt;span class=&quot;comment&quot;&gt;#设置该用户的密码，也可根据喜好配置成免密码登陆&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;新建一个目录作为要部署代码的根目录，如：&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#以我的项目为例&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mkdir /workspace/wechat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5. 将这个目录的属主和属组都改为上面新建的用户git&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /workspace&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    chown -R git:git *&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;切换到部署代码的专用用户&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;su - git&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;进入项目根目录，初始化为git仓库&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /workspace/wechat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    git init&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8. 【重要】让仓库接受代码提交&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    git config receive.denyCurrentBranch ignore&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [可选]  git config core.worktree ~/www&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    [可选]  git config --bool receive.denyNonFastForwards &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;#禁止强制推送&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    至此，一个空的git仓库就在服务器上建好了，仓库的地址为：&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    git@ipaddress/workspace/wechat/.git&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```            &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2.客户端准备&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;=&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1. 通过 ``` git &lt;span class=&quot;built_in&quot;&gt;clone&lt;/span&gt;```从 远程仓库上将代码获取到本地&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ```sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    git &lt;span class=&quot;built_in&quot;&gt;clone&lt;/span&gt; git@ipaddress:/workspace/webchat/.git&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#执行以上命令后能看到本地多了个文件夹&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#有可能会有以下警告，不用理会，这是因为服务端的仓库是空的&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;#warning: You appear to have cloned an empty repository.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    执行：git remote -v 会显示&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        origin  git@ipaddress:/workspace/wechat/.git (fetch)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        origin  git@ipaddress:/workspace/wechat/.git (push)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    至此远程仓库已关联上&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在clone下来的webchat文件下创建一个文件如：a.txt&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#在当前目录下打开gitbash&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git add .&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git commit -m &lt;span class=&quot;string&quot;&gt;&#39;test&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git push origin master&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#显示如下，代表已经push服务器仓库了&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Enter passphrase for key &#39;/c/Users/asus-pc/.ssh/id_rsa&#39;:&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Counting objects: 3, done.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Writing objects: 100% (3/3), 194 bytes | 0 bytes/s, done.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Total 3 (delta 0), reused 0 (delta 0)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#To git@114.112.156.248:/workspace/wechat/.git&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# * [new branch]      master -&amp;gt; master&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;2.回到服务器端继续配置&lt;br&gt;=&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;更新服务端 git 仓库状态并检出文件(执行完以下命令后，将看到服务端仓库也有了a.txt)，这是手动更新，太麻烦了，第二步配置自动更新服务器端代码&lt;/p&gt;
 &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /workspace/wechat&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git update-server-info&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git checkout &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#或者执行：&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git checkout branch_name     &lt;span class=&quot;comment&quot;&gt;# 如果push的不是master分支&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;设置服务器端更新钩子 &lt;figure class=&quot;highlight plain&quot;&gt;&lt;figcaption&gt;&lt;span&gt;```  &lt;/span&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;```sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;cd /workspace/wechat/.git/hooks&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#新建 post-receive &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;touch post-receive&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;vim post-receive&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#把以下内容复制进去保存&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#!/bin/sh&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; unset GIT_DIR&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; cd ..&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; git checkout -f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt; #这一步很重要，要有写的权限&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; chmod a+x post-receive&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;出于安全考虑，第二步创建的git用户不允许登录shell，这可以通过编辑/etc/passwd文件完成。找到类似下面的一行： &lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;git:x:1001:1001:,,,:/home/git:/bin/bash&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#修改为&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#这样，git用户可以正常通过ssh使用git，但无法登录shell&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ol&gt;
&lt;li&gt;继续本地新建文件，然后&lt;code&gt;git add .&lt;/code&gt; &lt;code&gt;git commit -m &amp;quot;注释&amp;quot;&lt;/code&gt; &lt;code&gt;git push origin master&lt;/code&gt;  去服务器上查看，服务器自动更新了我提交的内容，至此大功告成。   &lt;/li&gt;
&lt;/ol&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;每次本地代码都要手动上传到服务器在部署，对于懒人的我来说简直不能忍，于是折腾了下git自动化部署，期间踩了不少坑，记录一下防止下次遇到。&lt;br&gt;
    
    </summary>
    
      <category term="版本控制" scheme="http://cqblog.info/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
    
      <category term="git" scheme="http://cqblog.info/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>多层json对象嵌套的扁平化与去扁平化</title>
    <link href="http://cqblog.info/2016/06/29/javascript/"/>
    <id>http://cqblog.info/2016/06/29/javascript/</id>
    <published>2016-06-29T12:49:07.000Z</published>
    <updated>2016-06-29T13:23:26.164Z</updated>
    
    <content type="html">&lt;p&gt;废话不多说，直接上代码&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;今天遇到一个问题，多重json嵌套，要扁平化，弱鸡挣扎了下，找了个解决方案&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;//扁平化&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    JSON.flatten = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(data) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        var result = &amp;#123;&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; recurse(cur, prop) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (Object(cur) !== cur) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                result[prop] = cur;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (Array.isArray(cur)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (var i = 0, l = cur.length; i &amp;lt; l; i++)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    recurse(cur[i], prop + &lt;span class=&quot;string&quot;&gt;&quot;[&quot;&lt;/span&gt; + i + &lt;span class=&quot;string&quot;&gt;&quot;]&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (l == 0)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    result[prop] = [];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                var isEmpty = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (var p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; cur) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    isEmpty = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    recurse(cur[p], prop ? prop + &lt;span class=&quot;string&quot;&gt;&quot;.&quot;&lt;/span&gt; + p : p);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isEmpty &amp;amp;&amp;amp; prop)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                    result[prop] = &amp;#123;&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        recurse(data, &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;return&lt;/span&gt; result;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    //去扁平化&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    JSON.unflatten = &lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(data) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;use strict&quot;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (Object(data) !== data || Array.isArray(data))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;return&lt;/span&gt; data;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        var regex = /\.?([^.\[\]]+)|\[(\d+)\]/g,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            resultholder = &amp;#123;&amp;#125;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (var p &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; data) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            var cur = resultholder,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                prop = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                m;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (m = regex.exec(p)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                cur = cur[prop] || (cur[prop] = (m[2] ? [] : &amp;#123;&amp;#125;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                prop = m[2] || m[1];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            cur[prop] = data[p];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;return&lt;/span&gt; resultholder[&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;] || resultholder;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;测试用例：&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;var xml = &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        ToUserName: [&lt;span class=&quot;string&quot;&gt;&#39;阿斯顿&#39;&lt;/span&gt;],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        FromUserName: [&lt;span class=&quot;string&quot;&gt;&#39;啊实打实的&#39;&lt;/span&gt;],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        CreateTime: [&lt;span class=&quot;string&quot;&gt;&#39;hhhh123123123&#39;&lt;/span&gt;, &amp;#123;&lt;span class=&quot;string&quot;&gt;&quot;x&quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&quot;aaa&quot;&lt;/span&gt;&amp;#125;,[1, 2, 3, 4]],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        MsgType: [&lt;span class=&quot;string&quot;&gt;&#39;event&#39;&lt;/span&gt;],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Event: [&lt;span class=&quot;string&quot;&gt;&#39;sdf &#39;&lt;/span&gt;],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        EventKey: [&lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;],&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        xx: &lt;span class=&quot;string&quot;&gt;&#39;xx&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;扁平化结果：&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[0]: &lt;span class=&quot;string&quot;&gt;&quot;hhhh123123123&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[1].x: &lt;span class=&quot;string&quot;&gt;&quot;aaa&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[2][0]: 1,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[2][1]: 2,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[2][2]: 3,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    CreateTime[2][3]: 4,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    EventKey[0]: &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Event[0]: &lt;span class=&quot;string&quot;&gt;&quot;sdf &quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    FromUserName[0]: &lt;span class=&quot;string&quot;&gt;&quot;啊实打实的&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    MsgType[0]: &lt;span class=&quot;string&quot;&gt;&quot;event&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ToUserName[0]: &lt;span class=&quot;string&quot;&gt;&quot;阿斯顿&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    xx: &lt;span class=&quot;string&quot;&gt;&quot;xx&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;正好能满足需求&lt;br&gt;使用   &lt;strong&gt;JSON.flatten&lt;/strong&gt; 能还原去扁平化的值，不做演示。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;废话不多说，直接上代码&lt;br&gt;
    
    </summary>
    
      <category term="javascript" scheme="http://cqblog.info/categories/javascript/"/>
    
    
      <category term="json" scheme="http://cqblog.info/tags/json/"/>
    
  </entry>
  
  <entry>
    <title>nodejs微信开发(一)</title>
    <link href="http://cqblog.info/2016/06/29/wechat/"/>
    <id>http://cqblog.info/2016/06/29/wechat/</id>
    <published>2016-06-29T12:49:07.000Z</published>
    <updated>2016-06-30T02:13:32.387Z</updated>
    
    <content type="html">&lt;p&gt;废话不多说，直接上代码&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;废话不多说，直接上代码&lt;br&gt;
    
    </summary>
    
      <category term="nodejs" scheme="http://cqblog.info/categories/nodejs/"/>
    
    
      <category term="微信" scheme="http://cqblog.info/tags/%E5%BE%AE%E4%BF%A1/"/>
    
  </entry>
  
</feed>
